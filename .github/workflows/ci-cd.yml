name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Lint and code quality checks
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pylint
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run Black (Code Formatter Check)
        run: |
          echo "Checking code formatting with Black..."
          black --check --diff . || echo "⚠️ Code formatting issues found. Run 'black .' to fix."
        continue-on-error: true

      - name: Run isort (Import Sorting Check)
        run: |
          echo "Checking import sorting with isort..."
          isort --check-only --diff . || echo "⚠️ Import sorting issues found. Run 'isort .' to fix."
        continue-on-error: true

      - name: Run Flake8 (Style Guide Enforcement)
        run: |
          echo "Running Flake8 linting..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Pylint (Code Quality Analysis)
        run: |
          echo "Running Pylint analysis..."
          pylint lib/ main.py --exit-zero --max-line-length=127 --disable=C0111,R0903
        continue-on-error: true

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Safety (Dependency Vulnerability Check)
        run: |
          echo "Checking for known security vulnerabilities in dependencies..."
          safety check --json || echo "⚠️ Some vulnerabilities found in dependencies"
        continue-on-error: true

      - name: Run Bandit (Security Issue Scanner)
        run: |
          echo "Scanning code for common security issues..."
          bandit -r lib/ main.py -f json -o bandit-report.json || true
          bandit -r lib/ main.py || echo "⚠️ Potential security issues found"
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests with pytest
        run: |
          echo "Running test suite..."
          pytest tests/ -v --cov=lib --cov=main --cov-report=xml --cov-report=html --cov-report=term-missing -n auto

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/

  # Build and validate
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, security, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Validate application structure
        run: |
          echo "Validating application structure..."
          python -c "import lib.checker; import lib.trainer; print('✓ All modules imported successfully')"

      - name: Check for required files
        run: |
          echo "Checking for required files..."
          test -f main.py && echo "✓ main.py exists"
          test -f requirements.txt && echo "✓ requirements.txt exists"
          test -d lib && echo "✓ lib/ directory exists"
          test -d docs && echo "✓ docs/ directory exists"
          test -f docs/index.html && echo "✓ docs/index.html exists"

      - name: Lint frontend JavaScript
        run: |
          echo "Validating JavaScript files..."
          # Simple syntax check
          node -c docs/app.js && echo "✓ JavaScript syntax valid"
        continue-on-error: true

      - name: Build documentation
        run: |
          echo "Documentation available in docs/ directory"
          ls -la docs/

  # Frontend validation
  frontend:
    name: Validate Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate HTML
        run: |
          echo "Validating HTML files..."
          npx html-validate docs/index.html || echo "⚠️ HTML validation warnings"
        continue-on-error: true

      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript syntax..."
          node -c docs/app.js && echo "✓ JavaScript syntax valid"

      - name: Validate CSS
        run: |
          echo "Validating CSS files..."
          # CSS validation could be added here
          test -f docs/style.css && echo "✓ CSS file exists"

  # Deployment readiness check
  deploy-ready:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [build, frontend]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment configuration
        run: |
          echo "Checking deployment configuration..."
          test -f Procfile && echo "✓ Procfile exists"
          test -f runtime.txt && echo "✓ runtime.txt exists"
          echo "✓ Deployment configuration valid"

      - name: Generate deployment report
        run: |
          echo "# Deployment Report" > deployment-report.md
          echo "## Build Information" >> deployment-report.md
          echo "- Branch: ${{ github.ref_name }}" >> deployment-report.md
          echo "- Commit: ${{ github.sha }}" >> deployment-report.md
          echo "- Timestamp: $(date -u)" >> deployment-report.md
          echo "- Python Version: ${{ env.PYTHON_VERSION }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## Status: Ready for Deployment" >> deployment-report.md
          cat deployment-report.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

  # Notification job
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, frontend]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Pipeline execution completed"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
